{% extends "layout.html" %}
{% block content %}

<div class="container mt-5 text-center">
  <h2>Welcome Dr. {{ doctor.name }} üë®‚Äç‚öïÔ∏è</h2>
  <p class="mt-3">Status: 
    {% if doctor.status == "APPROVED" %}
      <span class="badge bg-success">Approved</span>
    {% else %}
      <span class="badge bg-warning">Pending</span>
    {% endif %}
  </p>

  <div class="card bg-dark p-4 mt-4 shadow-lg">
    <h4>Email: {{ doctor.email }}</h4>
    <h4>Specialization: {{ doctor.specialization }}</h4>
    <h4>Contact: {{ doctor.contact }}</h4>
    <a href="/logout" class="btn btn-danger mt-3">Logout</a>
  </div>
</div>

<h3 class="mt-4 text-center">üìä Scan Statistics Overview</h3>
<canvas id="scanChart" height="100"></canvas>


<!-- Floating Doctor Chatbot Button -->
<button id="doctorChatBtn" 
        class="btn btn-primary shadow-lg"
        style="position: fixed; bottom: 90px; right: 20px; border-radius: 50%; width: 60px; height: 60px; font-size: 28px;">
    ü©∫
</button>

<!-- Hidden Chatbot Box -->
<div id="doctorChatWindow"
     class="chatbot-box bg-dark text-white p-3 rounded shadow"
     style="position: fixed; bottom: 100px; right: 25px; width: 350px; display: none; border: 2px solid #0d6efd;">

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="m-0">ü§ñ Doctor Assistant</h5>
        <button class="btn btn-sm btn-danger" onclick="toggleDoctorChat()">X</button>
    </div>

    <div id="chat-output"
         style="height: 200px; overflow-y: auto; background: #222; padding: 10px; border-radius: 5px;">
    </div>

    <textarea id="doctor-chat-input"
              class="form-control mt-2"
              rows="2"
              placeholder="Ask something..."></textarea>

    <button class="btn btn-success w-100 mt-2" onclick="sendDoctorMessage()">Send</button>
</div>


<script>
// Toggle chatbot window open/close
function toggleDoctorChat() {
    const box = document.getElementById("doctorChatWindow");
    box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
}

document.getElementById("doctorChatBtn").onclick = toggleDoctorChat;

// Send message to backend
function sendDoctorMessage() {
    const msg = document.getElementById("doctor-chat-input").value;
    if (!msg.trim()) return;

    const output = document.getElementById("chat-output");
    output.innerHTML += `<p><strong>You:</strong> ${msg}</p>`;
    document.getElementById("doctor-chat-input").value = "";

    fetch("/doctor/chatbot", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
    })
    .then(res => res.json())
    .then(data => {
        output.innerHTML += `<p><strong>AI:</strong> ${data.reply}</p>`;
        output.scrollTop = output.scrollHeight;
    });
}
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartData = {{ chart_data | tojson }};
    
    const labels = chartData.map(u => u.name);
    const counts = chartData.map(u => u.cancer_count);

    const ctx = document.getElementById('scanChart').getContext('2d');

    const scanChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cancer Cases Detected',
                data: counts,
                backgroundColor: 'rgba(54, 162, 235, 0.5)'
            }]
        },
        options: {
            onClick: (e) => {
                const points = scanChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                if (points.length) {
                    const index = points[0].index;
                    const userId = chartData[index].id;
                    window.location.href = `/doctor/user/${userId}`;
                }
            }
        }
    });
</script>

{% endblock %}
